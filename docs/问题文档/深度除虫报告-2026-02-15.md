# 深度除虫报告（2026-02-15）

## 1. 扫描范围与方法
- 前端：`npm run test`、`npm run build`、关键页面与状态管理代码审查
- 后端：`venv/bin/python -m pytest -q`、`venv/bin/python -m ruff check .`
- 人工代码巡检：`store / page / service / memory / api` 关键路径

## 2. 本轮已修复问题

| 优先级 | 问题 | 处理结果 | 涉及文件 |
|---|---|---|---|
| P1 | `loading` 并发竞态（多请求时提前熄火） | 已修复，改为请求计数器 | `frontend/src/stores/useProjectStore.ts` |
| P1 | 项目详情“整书导出”是占位逻辑，功能不可用 | 已修复，改为真实拉取章节正文并导出 | `frontend/src/pages/ProjectDetail.tsx` |
| P1 | 整书导出可导出空正文文件 | 已修复，导出前过滤空内容并告警 | `frontend/src/services/exportService.ts` |
| P2 | 导出菜单在“无正文”情况下仍展示整书导出入口 | 已修复，基于正文存在性判断 | `frontend/src/components/chapter/ChapterExportMenu.tsx` |
| P2 | 项目列表缺少搜索/筛选，项目多时可用性差 | 已修复，新增关键词与状态筛选工具条 | `frontend/src/pages/ProjectList.tsx` |
| P2 | 移动端侧栏隐藏后缺乏页面导航 | 已修复，新增移动端顶部快捷导航 | `frontend/src/components/layout/AppLayout.tsx` |
| P2 | 新建项目弹窗缺少键盘效率路径 | 已修复，新增 `Esc` 关闭、`Ctrl/Cmd+Enter` 提交、自动聚焦 | `frontend/src/components/project/ProjectCreateModal.tsx` |
| P3 | 后端裸 `except` 与无用导入 | 已修复，规范为 `except Exception` 并清理导入 | `backend/agents/studio.py` 等 |

## 3. 仍存在问题清单（尽可能完整）

> 说明：以下为“未在本轮完全消化”的问题，按优先级建议迭代处理。

### P1（建议下个迭代优先）
1. 前端单文件包体积仍过大（`~1MB+`），首次加载成本偏高。
2. `KnowledgeGraphPage / MemoryBrowserPage` 测试存在大量 `act(...)` 警告，说明异步状态更新测试策略不稳。
3. 前端缺失 ESLint 配置，`npm run lint` 当前不可作为质量门禁。
4. `ChapterWorkbenchPage` 中“整书导出”上下文仍无法一次性拿到全部章节正文（当前仅保证不导出空文件，体验仍不完整）。
5. 项目删除动作仍是“一步删除”，缺二次确认/撤销机制，误删风险高。

### P2（应逐步治理）
6. 大量页面含大量内联样式，主题迭代与一致性维护成本高。
7. 多处 `console.error` 直接输出，错误分级与可观测性不足。
8. 网络请求失败的“重试机制”普遍缺失（如项目详情、记忆检索）。
9. Store 与页面层对错误态的数据回退策略不统一（有的清空，有的保留旧数据）。
10. 章节相关流程中用户等待态提示不一致（不同页面反馈风格不统一）。
11. 项目列表卡片点击+内部按钮并存，虽已 stopPropagation，但可进一步明确可点击区语义。
12. `api` 仅使用固定 `baseURL=/api`，多环境切换能力弱。
13. 导出流程缺少“进度提示/失败重试”机制（目前是一次动作）。
14. 章节长文本编辑区缺自动保存（高风险操作易丢稿）。
15. 关键高耗时操作（批量生成）缺可追踪任务历史页。
16. 页面级骨架屏策略不统一，部分页面在高延迟下反馈层级不足。
17. 图表页（Dashboard）在移动端可读性仍一般，未做更精细断点布局优化。
18. 缺统一的空态插图/引导文案规范，当前空态体验割裂。
19. 缺统一表单校验信息样式（字段级错误提示偏少）。
20. 按钮禁用原因不可见（例如为什么当前不可点击）。

### P3（可排期优化）
21. 一些文案术语不统一（“整卷/整本/一键生成”等语义边界可再明确）。
22. 样式层存在历史遗留规则重复定义，可进一步瘦身。
23. Toast 信息去重策略未建立，高频场景可能刷屏。
24. 表格列宽/内容截断策略可进一步标准化。
25. 页面间缺“最近访问项目/最近章节”快捷入口。

## 4. 本轮验证结果
- 前端测试：`24 passed / 262 passed`
- 前端构建：通过
- 后端测试：`15 passed`
- 后端 ruff：通过

## 5. 建议执行顺序（下一步）
1. 先补齐 `lint` 质量门禁（ESLint 配置 + CI）
2. 清理 `act(...)` 警告与 React Router future flags
3. 做代码分割（按路由拆包）降低首屏 JS
4. 完整打通“整书导出（批量拉取全文）”与失败重试
5. 补齐危险操作确认/撤销与草稿自动保存
