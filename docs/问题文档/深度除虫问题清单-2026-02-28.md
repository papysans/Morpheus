# 深度除虫问题清单（只读排查）- 2026-02-28

> 范围：`frontend`、`backend`、测试与构建链路。  
> 约束：本次仅排查与记录，不修改业务代码。

---

## 一、排查执行记录（证据）

### 前端

1. `npm run lint`（`/frontend`）
   - 结果：失败
   - 关键报错：`ESLint couldn't find a configuration file`

2. `npm run test`（`/frontend`）
   - 结果：失败（日志显示多个失败用例与失败套件）
   - 关键失败证据：
     - `No "LLM_TIMEOUT" export is defined on the "../../lib/api" mock`
     - `Playwright Test did not expect test() to be called here`
     - 多个页面测试断言失败（`ProjectDetail`, `KnowledgeGraphPage`, `Sidebar`, `ChapterWorkbenchPage`）

3. `npm run build`（`/frontend`）
   - 结果：失败（TypeScript 编译错误）
   - 关键报错：
     - `src/config/features.ts(9,60): error TS2339: Property 'env' does not exist on type 'ImportMeta'`
     - `src/pages/__tests__/ProjectDetail.test.tsx`: `ChapterItem` 缺少必需字段 `synopsis`

### 后端

1. `python3 -m pytest -q`（`/backend`）
   - 结果：通过（`120 passed, 3 warnings`）
   - 警告证据：
     - `datetime.utcnow()` 弃用警告（`backend/api/main.py:3145`）
     - `table_names()` 弃用警告（lancedb）

2. `python3 -m ruff check .`、`python3 -m mypy .`
   - 结果：未执行成功
   - 原因：运行环境缺少模块（`No module named ruff` / `No module named mypy`）

3. `poetry run ruff check .`、`poetry run mypy .`
   - 结果：未执行成功
   - 原因：Poetry 环境内命令缺失（`Command not found: ruff` / `Command not found: mypy`）

---

## 二、问题清单（按优先级）

## P0（阻塞交付/CI）

### P0-1 前端 lint 无法启动（缺 ESLint 配置）
- **现象**：`npm run lint` 直接失败。
- **证据**：`ESLint couldn't find a configuration file`
- **影响**：静态检查门禁失效，CI 无法依赖 lint 结果。
- **建议**：补齐并统一 ESLint 配置入口（`.eslintrc*` 或 `eslint.config.*`）。

### P0-2 前端构建失败（TypeScript 编译中断）
- **现象**：`npm run build` 失败。
- **证据**：
  - `src/config/features.ts(9,60): Property 'env' does not exist on type 'ImportMeta'`
  - `src/pages/__tests__/ProjectDetail.test.tsx` 多处 `ChapterItem` 缺少 `synopsis`
- **影响**：前端产物不可构建，发布阻塞。
- **建议**：
  - 修复 `ImportMeta` 环境变量类型声明（Vite 类型注入）；
  - 统一测试数据与 `ChapterItem` 类型契约。

### P0-3 前端测试链路混跑导致失败（Vitest 与 Playwright 互相污染）
- **现象**：`npm run test`（Vitest）执行时命中 `e2e/*.spec.ts` 并报错。
- **证据**：
  - `FAIL e2e/smoke.spec.ts`
  - `FAIL e2e/system-bugfix.spec.ts`
  - `FAIL e2e/templates.spec.ts`
  - `Playwright Test did not expect test() to be called here`
- **影响**：单测与 E2E 边界不清，测试结果不可信。
- **建议**：隔离测试匹配规则（Vitest 仅收敛 unit/integration，E2E 由 Playwright 命令独立执行）。

---

## P1（高风险缺陷）

### P1-1 `ChapterWorkbenchPage` 测试 mock 与生产接口契约不一致
- **现象**：蓝图相关用例报错并触发错误 toast。
- **证据**：
  - 报错：`No "LLM_TIMEOUT" export is defined on the "../../lib/api" mock`
  - 代码：
    - `frontend/src/lib/api.ts:10` 导出 `LLM_TIMEOUT`
    - `frontend/src/pages/ChapterWorkbenchPage.tsx:500` 使用 `LLM_TIMEOUT`
    - `frontend/src/pages/__tests__/ChapterWorkbenchPage.test.tsx:65-72` mock 未返回 `LLM_TIMEOUT`
- **影响**：测试误报，掩盖真实回归信号。
- **建议**：测试 mock 与实际模块导出保持同构。

### P1-2 后端存在吞异常（`except ...: pass`）导致故障静默
- **现象**：关键路径遇错后静默继续。
- **证据（示例）**：
  - `backend/memory/search.py:79-81`
  - `backend/memory/__init__.py:248-251`
  - `backend/core/llm_client.py:83-84`
  - `backend/api/main.py:2645-2646, 3342-3343, 4552-4553, 5196-5197`
- **影响**：问题被隐藏，数据一致性与排障效率下降。
- **建议**：改为可观测处理（限定异常类型 + 结构化日志 + 必要时向上抛出）。

### P1-3 前端生产源码出现 `as any`（类型安全退化）
- **现象**：生产路径存在 `as any`。
- **证据**：`frontend/src/stores/useProjectStore.ts:87` (`const e = error as any`)
- **影响**：弱化类型保障，易引入隐式运行时错误。
- **建议**：收敛为显式 error narrow（如 AxiosError 判定）并规范错误类型。

---

## P2（中风险/技术债）

### P2-1 后端时间 API 使用弃用写法
- **现象**：pytest 警告 `datetime.utcnow()` 弃用。
- **证据**：`backend/api/main.py:3145`
- **影响**：未来 Python 版本升级风险。
- **建议**：替换为 timezone-aware UTC 写法。

### P2-2 后端依赖 API 弃用（LanceDB `table_names()`）
- **现象**：pytest 警告 `table_names() is deprecated, use list_tables()`。
- **影响**：依赖升级后兼容风险。
- **建议**：逐步迁移到新 API。

### P2-3 后端静态检查工具链未接通
- **现象**：ruff/mypy 在系统 Python 与 Poetry 环境均不可用。
- **影响**：后端 lint/typecheck 盲区，问题只能靠运行期暴露。
- **建议**：补齐 dev 依赖与执行脚本，恢复 CI 门禁。

---

## 三、复现线索（最短路径）

1. 前端 lint 失败：

```bash
cd /Volumes/Work/Projects/Morpheus/frontend
npm run lint
```

2. 前端测试混跑失败：

```bash
cd /Volumes/Work/Projects/Morpheus/frontend
npm run test
```

3. 前端构建失败：

```bash
cd /Volumes/Work/Projects/Morpheus/frontend
npm run build
```

4. 后端警告与工具链缺失：

```bash
cd /Volumes/Work/Projects/Morpheus/backend
python3 -m pytest -q
python3 -m ruff check .
python3 -m mypy .
poetry run ruff check .
poetry run mypy .
```

---

## 四、建议修复顺序

1. **先修门禁**：P0-1 / P0-2 / P0-3（保证 CI 可用且结果可信）
2. **再修高风险缺陷**：P1-1 / P1-2 / P1-3（减少误报与静默故障）
3. **最后收敛技术债**：P2 系列（弃用 API、工具链完善）

---

## 五、已完成快修（2026-02-28）

- [x] **P1-1** 测试 mock 与生产契约对齐：`ChapterWorkbenchPage.test.tsx` 已补 `LLM_TIMEOUT` 导出 mock。
- [x] **P0-2（部分）** `ProjectDetail` 测试数据补齐 `synopsis` 字段，消除 `ChapterItem` 类型不匹配。
- [x] **P0-2（部分）** 增加 `frontend/src/vite-env.d.ts`，修复 `ImportMeta.env` 类型声明缺失导致的构建报错。
- [x] **P0-3（部分）** `vitest.config.ts` 限定仅运行 `src/**/*.{test,spec}.{ts,tsx}`，排除 `e2e/**`，避免 Vitest 混跑 Playwright 用例。
- [x] **P0-3（部分）** `Sidebar.test.tsx` 已对齐当前侧边栏实际行为（品牌文案 `Morpheus`、图谱开关关闭时的子导航项数量与高亮索引），相关用例恢复通过。
- [x] **P0-1** 已补齐 `frontend/.eslintrc.cjs` 并接入 `eslint-plugin-react-hooks`，`npm run lint` 可执行并通过。

> 说明：本轮按要求绕开知识图谱功能恢复相关实现，仅处理可快速落地且低耦合的问题。
