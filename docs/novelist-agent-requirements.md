# 小说家 Agent（炫技版）需求文档 v1.0

## 文档摘要
本项目是一个本地单机的“多 Agent 编剧室”系统，目标是在 30 万字级长篇小说中，同时实现高一致性与高表现力写作。系统采用 Openclaw 风格三层记忆（Markdown 真相源）+ 混合检索 + 轻量知识图谱 + 批评修订闭环，并以本地 Web UI 实时展示记忆调用、冲突检测、决策链路，作为核心“炫技”演示能力。

## 1. 项目目标与成功标准
### 1.1 目标
- G1：实现连续长篇写作不中断，前后设定一致。
- G2：实现多 Agent 协作生成，形成可追溯创作决策链。
- G3：实现记忆可视化回放，展示“为什么写出这一段”。
- G4：实现重大冲突自动阻断并可人工修复。

### 1.2 成功标准
- S1：连续自动 + 人工协作生成 20 章，重大冲突率 <= 0.2/章。
- S2：关键设定召回命中率 >= 85%。
- S3：每章都可查看检索证据、Agent 决策、冲突报告、回写记录。
- S4：MVP 全程本地可运行，单用户可在 30 分钟内完成从建项到首章交付。

## 2. 产品范围
### 2.1 In Scope
- 本地 Web UI
- 项目管理
- 三层记忆
- 混合检索
- 轻量图谱
- 多 Agent 编剧室
- 章节计划/草稿/修订
- 冲突阻断
- 记忆回写
- 可视化回放
- 评测看板

### 2.2 Out of Scope
- 多租户云服务
- 实时协同编辑
- 商业支付系统
- 移动端 App
- 全自动百万字无人值守生成

## 3. 用户与场景
### 3.1 用户
- U1：个人创作者，按章节共写，手动审批关键输出。

### 3.2 场景
- C1：输入章节目标，系统生成章节蓝图，人工确认后出草稿。
- C2：系统检测到设定冲突，阻断并给出修复建议，用户选择修复路径后重写。
- C3：用户点击任意段落，查看“命中记忆证据 + Agent 决策轨迹”。
- C4：用户回看人物关系图和事件时间线，验证长程一致性。

## 4. 核心功能需求（FR）
| ID | 需求 | 验收标准 |
|---|---|---|
| FR-001 | 支持创建小说项目（题材、文风、目标篇幅、禁忌约束） | 创建后自动初始化目录与模板文件 |
| FR-002 | 三层记忆文件自动维护（L1/L2/L3） | 每次章节提交后三层文件均有结构化更新 |
| FR-003 | 混合检索（FTS + 向量 + 时间线 + 图谱过滤） | 返回综合得分、来源、证据片段 |
| FR-004 | 多 Agent 编剧室协作 | 至少包含导演、设定官、连续性审校、文风润色四角色 |
| FR-005 | 章节蓝图生成 | 输出节拍、冲突点、伏笔回收计划、角色目标 |
| FR-006 | 正文草稿生成（可流式） | 支持分段生成与中断续写 |
| FR-007 | 一致性检测与分级 | 输出 P0/P1/P2 冲突并附证据路径 |
| FR-008 | 重大冲突阻断 | P0 冲突时禁止提交，必须修复或豁免 |
| FR-009 | 人工审批与修订回合 | 用户可接受、退回、局部重写、重检 |
| FR-010 | 记忆反思回写（Retain/Recall/Reflect） | 每章提交后生成“保留/降权/新事实”条目 |
| FR-011 | 可视化回放 | 查看 Agent 序列、检索命中、冲突演化、最终定稿 |
| FR-012 | 评测看板 | 展示冲突率、召回率、返工率、章节产出效率 |

## 5. 非功能需求（NFR）
- NFR-001（性能）：单次章节检索（TopK=30）95 分位 < 2.5s（本地开发机）。
- NFR-002（稳定性）：连续 3 小时会话无崩溃，失败任务可重试。
- NFR-003（可解释性）：每段正文可追溯到至少一个证据链节点或规则说明。
- NFR-004（可维护性）：记忆真相源全部为 Markdown，可手工审阅和修订。
- NFR-005（可扩展性）：模型提供商可替换，Agent 角色可增删。
- NFR-006（安全性）：默认本地运行，不上传项目原文；API Key 本地安全存储。
- NFR-007（可观测性）：关键链路有结构化日志和运行指标。

## 6. 技术架构要求
- 后端：Python FastAPI
- 前端：React 本地 Web UI
- 记忆真相源：Markdown 文件系统
- 文本检索：SQLite FTS
- 语义检索：LanceDB 向量索引
- 图谱：轻量 JSONL/SQLite 图关系层（实体、关系、事件、时间）
- 编排：有向状态流（多 Agent handoff + 审批节点）
- 模型策略：API 优先，统一适配层支持后续本地模型切换

## 7. 三层记忆规范
### 7.1 L1 稳态记忆
- 文件：`IDENTITY.md`
- 内容：世界观规则、角色硬设定、文风契约、硬禁忌

### 7.2 L2 过程记忆
- 文件：`logs/daily/*.md` 与 `MEMORY.md`
- 内容：章节决策、未决事项、临时线索

### 7.3 L3 长期记忆
- 内容：章节摘要、事件卡、关系变更、主题演化
- 属性：支持重要度与时效度

### 7.4 回写策略
- 每章结束执行反思任务，提取新事实、冲突修复、过时信息降权。

### 7.5 检索优先级
- L1 硬约束 > L3 长期事实 > L2 近期上下文。

## 8. 数据模型与接口契约
- `MemoryItem`：`id, layer, source_path, summary, embedding, entities, time_span, importance, recency`
- `EntityState`：`entity_id, attrs, constraints, last_seen_chapter`
- `EventEdge`：`event_id, subject, relation, object, chapter, timestamp, confidence`
- `Conflict`：`id, severity, rule_id, evidence_paths, reason, suggested_fix`
- `ChapterPlan`：`chapter_id, beats, goals, foreshadowing, callback_targets`
- `AgentDecision`：`agent_role, input_refs, decision_text, rejected_options, timestamp`

## 9. API 需求（MVP）
- `POST /projects`：创建项目并初始化目录。
- `GET /projects/{id}`：读取项目配置与状态。
- `POST /chapters/{id}/plan`：生成章节蓝图。
- `POST /chapters/{id}/draft`：生成章节草稿。
- `POST /consistency/check`：执行一致性检查。
- `POST /memory/commit`：审批后回写记忆与索引。
- `GET /memory/query`：调试查询与证据查看。
- `GET /trace/{chapter_id}`：获取多 Agent 决策与检索回放数据。

## 10. 多 Agent 编剧室职责
- 导演 Agent：分解章节目标，控制节奏与冲突推进。
- 设定官 Agent：维护世界观与角色硬约束。
- 连续性审校 Agent：执行时间线、关系链、事实冲突检查。
- 文风润色 Agent：在不破坏事实前提下优化叙事表现。
- 裁决器 Agent：合并意见并输出最终草稿建议。
- 人类作者：审批、修订、豁免、最终提交。

## 11. 一致性规则引擎
- R1：时间线一致性（先后顺序、年龄、里程碑）。
- R2：角色状态一致性（生死、伤病、立场、能力边界）。
- R3：关系一致性（亲疏、敌友、承诺与背叛）。
- R4：世界规则一致性（魔法/科技/制度硬约束）。
- R5：伏笔兑现一致性（埋点、回收、未决项追踪）。
- 严重级别：P0 必阻断，P1 强警告可人工豁免，P2 仅提示。

## 12. 前端交互要求
- P1：项目总览（进度、冲突率、角色数、事件数）。
- P2：章节工作台（目标输入、蓝图、草稿、审批）。
- P3：记忆浏览器（三层记忆树、全文检索、差异对比）。
- P4：图谱视图（角色关系图、事件时间线）。
- P5：回放视图（Agent 决策链、证据命中、冲突演化）。
- I1：点击正文段落可反查证据链。
- I2：冲突卡支持一键跳转到冲突源文件。

## 13. 可观测性与评测
### 13.1 指标
- M1：章节生成耗时、检索耗时、冲突检测耗时。
- M2：每章冲突数、P0 占比、豁免率。
- M3：记忆召回命中率、误召回率。
- M4：人工返工率、一次通过率。

### 13.2 评测
- E1：固定基准小说设定集回归测试。
- E2：连续 20 章压力写作回归。
- E3：角色/时间线对抗样例集（故意注入冲突）。

## 14. 安全与数据治理
- 本地优先，不默认上传原文内容。
- API Key 存储于本地安全配置，不写入日志。
- 日志脱敏处理（人名可选匿名化）。
- 支持项目级导出与删除。

## 15. 项目里程碑
- M1（第 1-2 周）：项目骨架、三层记忆、基础检索、章节生成。
- M2（第 3 周）：多 Agent 编排、章节审批流。
- M3（第 4 周）：一致性规则引擎 + P0 阻断。
- M4（第 5 周）：轻量图谱 + 时间线校验。
- M5（第 6 周）：回放可视化 + 评测看板 + 演示脚本。

## 16. 测试与验收用例
- TC-001：创建项目后目录、模板、索引初始化完整。
- TC-002：给定固定章节目标，蓝图输出包含节拍与伏笔计划。
- TC-003：注入“已死亡角色再次出场”应触发 P0 阻断。
- TC-004：修复冲突后二次检测应通过或降级。
- TC-005：点击正文任意段落可查看证据链与 Agent 决策。
- TC-006：连续 20 章运行后系统稳定且指标达标。
- UAT-001：作者可在 5 步内完成“目标输入 -> 审批提交”。
- UAT-002：演示模式可完整回放一章从规划到定稿的全过程。

## 17. 风险与缓解
- K1：多 Agent 成本与延迟偏高。缓解：分级调用、缓存、可切单 Agent 快速模式。
- K2：图谱抽取误差导致误报。缓解：置信度阈值与人工确认入口。
- K3：检索噪声干扰写作。缓解：重排器 + 规则优先级 + 白名单证据。
- K4：文风与一致性冲突。缓解：事实先行、润色后置、双通道评分。

## 18. 参考技术依据（截至 2026-02-14）
1. [Openclaw Docs](https://docs.openclaw.ai/)
2. [Openclaw Memory Research](https://docs.openclaw.ai/memory-research)
3. [Microsoft GraphRAG](https://microsoft.github.io/graphrag/)
4. [LangGraph Multi-Agent](https://langchain-ai.github.io/langgraph/concepts/multi_agent/)
5. [Letta Memory Blocks](https://docs.letta.com/guides/agents/memory-blocks)
6. [CritiCS (EMNLP 2024)](https://aclanthology.org/2024.emnlp-main.1052/)
7. [CoGWriter (ACL 2025)](https://aclanthology.org/2025.acl-long.547/)
8. [Re3 (EMNLP 2022)](https://aclanthology.org/2022.emnlp-main.296/)

## 19. Assumptions & Defaults
- 默认单用户本地运行。
- 默认中文写作，后续可扩多语言。
- 默认章节驱动共写，不做全自动无人监督写作。
- 默认 API 模型优先，保留本地模型接口。
- 默认 P0 冲突阻断，P1/P2 可审阅继续。
- 默认目标规模为 30 万字，按卷归档摘要。
- 默认“炫技主轴”为多 Agent 编剧室 + 记忆可视化回放。
